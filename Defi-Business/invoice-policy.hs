{-# LANGUAGE DataKinds #-}
{-# LANGUAGE NoImplicitPrelude #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE ScopedTypeVariables #-}
{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE TypeApplications #-}

module Main where

import Prelude (IO, FilePath, putStrLn, (<>), String)
import qualified Prelude as P

import Plutus.V2.Ledger.Api
import Plutus.V2.Ledger.Contexts
import PlutusTx
import PlutusTx.Prelude hiding (Semigroup(..), unless)

import Plutus.V1.Ledger.Value
    ( flattenValue
    , AssetClass(..)
    , assetClassValueOf
    )

import qualified Codec.Serialise as Serialise
import qualified Data.ByteString.Lazy  as LBS
import qualified Data.ByteString       as BS
import qualified Data.ByteString.Base16 as B16

--------------------------------------------------------------------------------
-- CONFIG: INVOICE FINANCING VALIDATOR HASH
--------------------------------------------------------------------------------

{-# INLINABLE financingValidatorHash #-}
financingValidatorHash :: ValidatorHash
financingValidatorHash =
    ValidatorHash "590d260100003232323232332232323232323232323322323233223232323232323232323322323232323232322323232323223223232533532323232533500315335323235002222222222222533533355302812001501f25335333573466e3c0380041000fc4d40d8004540d40108410040f8d401488888014d40088800840c44cd5ce248118697373756572207369676e6174757265206d697373696e6700030153355335333573466e20ccc040ccd54c058480054051408ccd54c048480048d4004888800cd5400488888888888802804c04cd4010888880080c00c440c44cd5ce24811672657061796d656e7420696e73756666696369656e740003015335533533355301a120013233501c2233350032200200200135001220011233001225335002100110330322333573466e20ccc044ccd54c05c4800540554090c8c8d4004888888888888ccd54c0944800488d40088888d401088cd400894cd4ccd5cd19b8f017001049048133503a00600810082008503200a50033500122002014014337006a0024400266e0ccdc11a8009100099b8135005222220023500522222003350052222200303103235004222220011031133573892112696e766573746f7273206e6f742070616964000301533553353500222350022222222222223333500d25035250352503523335530291200150202350012253355335333573466e3cd400888008d40108800810c1084ccd5cd19b873500222001350042200104304210421350390031503800d21333573466e1cd4d40148888801088ccc04cd4d400c88004888800c008005200203203113263203333573892010f6e6f2073637269707420696e7075740003410311335738920118696e766f696365204e4654206e6f742072656c65617365640003010301030135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40a80acd5d0a80619a8150159aba1500b33502a02c35742a014666aa05ceb940b4d5d0a804999aa8173ae502d35742a01066a0540706ae85401cccd540b80e5d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd410dd69aba150023044357426ae8940088c98c8120cd5ce02402482309aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a821bad35742a00460886ae84d5d1280111931902419ab9c048049046135573ca00226ea8004d5d09aba2500223263204433573808808a08426aae7940044dd50009aba1500533502a75c6ae854010ccd540b80d48004d5d0a801999aa8173ae200135742a004606e6ae84d5d1280111931902019ab9c04004103e135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008604e6ae84d5d1280211931901919ab9c0320330303333573466e1d40152002212200123333573466e1d40192000212200223263203233573806406606005e6666ae68cdc39aab9d500a480008ccccc8888848ccccc00401801401000c008dd71aba1500a3232323333573466e1cd55cea80124000466aa04a6eb8d5d0a8011bae357426ae8940088c98c80d0cd5ce01a01a81909aab9e5001137540026ae854024dd69aba15008375a6ae85401ccd40688c8c8cccd5cd19b8735573aa00490001199109198008018011bae35742a0046eb4d5d09aba2500223263203433573806806a06426aae7940044dd50009aba135744a00e464c6406066ae700c00c40b840c0584d55cf280089baa001135573a6ea80044d5d1280089aba25001135744a00226aae7940044dd500091119191800802990009aa8151119a800a4000446a00444a66a666ae68cdc78010048158150980380089803001990009aa8149119a800a4000446a00444a66a666ae68cdc7801003815014880089803001899a80511299a801108018800a80a990009aa812110891299a8008a80a91099a80b180200119aa980309000802000a450012233553007120012350012233550150023355300a12001235001223355018002333500123302a4800000488cc0ac0080048cc0a800520000013355300712001235001223355015002333500123355300b1200123500122335501900235500d0010012233355500800f00200123355300b1200123500122335501900235500c00100133355500300a002001111222333553004120015010335530071200123500122335501500235500900133355300412001223500222533533355300c120013233500e223335003220020020013500122001123300122533500210261001023235001223300a002005006100313350140040035011001335530071200123500122323355016003300100532001355027225335001135500a003221350022253353300c002008112223300200a0041300600300232001355020221122253350011002221330050023335530071200100500400111212223003004112122230010043200135501d22112253350011500e22133500f300400233553006120010040013200135501c2211222533500113500322001221333500522002300400233355300712001005004001122123300100300222333573466e3c00800405c05848c88c008dd6000990009aa80d111999aab9f0012500a233500930043574200460066ae880080688c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8064cd5ce00c80d00b89aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c8078cd5ce00f00f80e09aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404066ae700800840780740704d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201a33573803403603026ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355017223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba20030181357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900a19ab9c014015012011135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900919ab9c01201301000f00e00d135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900719ab9c00e00f00c135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8030cd5ce00600680509baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8054cd5ce00a80b00980900880800780700689aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401c66ae7003803c03002c4d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200b33573801601801201026aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401866ae700300340280240204d55cea80089baa0012323333573466e1d40052002200523333573466e1d40092000200523263200833573801001200c00a26aae74dd5000891001091000a4c92010350543100120012233700004002224646002002446600660040040021"

--------------------------------------------------------------------------------
-- Minting Policy
--------------------------------------------------------------------------------

{-# INLINABLE mkDocPolicy #-}
mkDocPolicy :: ScriptContext -> Bool
mkDocPolicy ctx =
    traceIfFalse "must mint exactly one invoice NFT" singleMint &&
    traceIfFalse "issuer must sign transaction" issuerSigned &&
    traceIfFalse "NFT not locked at financing contract" nftLocked
  where
    info :: TxInfo
    info = scriptContextTxInfo ctx

    ownCS :: CurrencySymbol
    ownCS = ownCurrencySymbol ctx

    minted :: [(CurrencySymbol, TokenName, Integer)]
    minted = flattenValue (txInfoMint info)

    --------------------------------------------------------
    -- Exactly one NFT minted under this policy
    --------------------------------------------------------
    singleMint :: Bool
    singleMint =
        case minted of
            [(cs, _, amt)] -> cs == ownCS && amt == 1
            _              -> False

    --------------------------------------------------------
    -- Issuer must sign
    --------------------------------------------------------
    issuerSigned :: Bool
    issuerSigned =
        case txInfoSignatories info of
            [_] -> True
            _   -> False

    --------------------------------------------------------
    -- NFT must be locked at the financing validator
    --------------------------------------------------------
    nftLocked :: Bool
    nftLocked =
        any outputHasNFT (txInfoOutputs info)

    outputHasNFT :: TxOut -> Bool
    outputHasNFT o =
        case txOutAddress o of
            Address (ScriptCredential vh) _ ->
                vh == financingValidatorHash &&
                assetClassValueOf
                    (txOutValue o)
                    (AssetClass (ownCS, mintedTokenName)) == 1
            _ -> False

    mintedTokenName :: TokenName
    mintedTokenName =
        case minted of
            [(_, tn, _)] -> tn
            _            -> traceError "invalid mint"

--------------------------------------------------------------------------------
-- Untyped Wrapper
--------------------------------------------------------------------------------

{-# INLINABLE mkPolicy #-}
mkPolicy :: BuiltinData -> BuiltinData -> ()
mkPolicy _ ctx =
    if mkDocPolicy (unsafeFromBuiltinData ctx)
    then ()
    else error ()

policy :: MintingPolicy
policy =
    mkMintingPolicyScript
        $$(PlutusTx.compile [|| mkPolicy ||])

--------------------------------------------------------------------------------
-- CBOR Writer
--------------------------------------------------------------------------------

writeCBOR :: FilePath -> MintingPolicy -> IO ()
writeCBOR path val = do
    let bytes = LBS.toStrict (Serialise.serialise val)
    BS.writeFile path (B16.encode bytes)
    putStrLn $ "CBOR hex written to: " <> path

--------------------------------------------------------------------------------
-- Main
--------------------------------------------------------------------------------

main :: IO ()
main = do
    writeCBOR "invoice_document_policy.cbor" policy
    putStrLn "\n--- Invoice Document Minting Policy Compiled ---"
