import {
  Lucid,
  Blockfrost,
  Data,
  Constr
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

/* =====================================================
   CONFIG
===================================================== */

const BLOCKFROST_URL = "https://cardano-preprod.blockfrost.io/api/v0";
const BLOCKFROST_KEY = "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
const NETWORK = "Preprod";

/* =====================================================
   SCRIPT (REPLACE WITH YOUR CBOR)
===================================================== */

const SCRIPT = {
  type: "PlutusV2",
  script: "590e1901000032323232323322323232323232323232332232323322323232323232323232323232323233223232323222322323253353232323253335003153355335533535004222220042102f102f102f1335738921136f6666657220616c72656164792074616b656e0002e153355335333573466e20ccc04cccd54c0384800540314090cc02cd4010888880154004064064d40108888800c0b80bc40bc4cd5ce249127072696e636970616c206e6f7420706169640002e15335533553353015002213500122350012222350092235002222222222222333553023120012235002222253353501822350062232335005233500425335333573466e3c0080041441405400c414081408cd4010814094cd4ccd5cd19b8f002001051050150031050153350032153350022133500223350022335002233500223303700200120532335002205323303700200122205322233500420532225335333573466e1c01800c15815454cd4ccd5cd19b870050020560551333573466e1c01000415815441544154413854cd40048413841384cd40f8018014401540e40284c98c80c4cd5ce2481024c6600032102e221533500115333535002222200210302135301d00122222533500421038103621031221032102f133573892111646174756d206e6f7420757064617465640002e102e102e1533553353301450013500422222005102f133573892113626f72726f776572206e6f74207369676e65640002e153355335301500221333573466e20ccc050d4d400488004888800c068068d4014888880040bc0c040b840bc4cd5ce24912636f6c6c61746572616c206d697373696e670002e102e1533553353301450013500422222005102f133573892113626f72726f776572206e6f74207369676e65640002e1533553355335350042222200421333573466e20ccc050c8ccd54c0404800540394098cc0340080054008068068cdc01a802911110019a8029111100101781808170817899ab9c4910f6c656e646572206e6f7420706169640002e153355335301500221333573466e1cccc050d4d400488004888800c068068d4014888880040c00bc40b840bc4cd5ce24917636f6c6c61746572616c206e6f742072656c65617365640002e102e102e135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40a00a4d5d0a80619a8140149aba1500b33502802a35742a014666aa05eeb940b8d5d0a804999aa817bae502e35742a01066a05006c6ae85401cccd540bc0ddd69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4105d69aba150023042357426ae8940088c98c8118cd5ce02302382209aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a820bad35742a00460846ae84d5d1280111931902319ab9c046047044135573ca00226ea8004d5d09aba2500223263204233573808408608026aae7940044dd50009aba1500533502875c6ae854010ccd540bc0cc8004d5d0a801999aa817bae200135742a004606a6ae84d5d1280111931901f19ab9c03e03f03c135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008604a6ae84d5d1280211931901819ab9c03003102e3333573466e1d401520042122200123333573466e1d401920022122200323333573466e1d401d20002122200223263203133573806206405e05c05a602c00c205c2c26aae7940044dd500089aab9d3754002446a002444444444444666aa602224002446a00444446a0084466a0044a66a666ae68cdc780b80081d81d099a81780300408041004281380509119aa98038900091a8009119aa80f00119aa98050900091a8009119aa810801199a800919818240000024466062004002466060002900000099aa98038900091a8009119aa80f001199a800919aa98058900091a8009119aa8110011aa80680080091199aaa804006801000919aa98058900091a8009119aa8110011aa806000800999aaa801804001000888911199aa980209000a80c99aa98038900091a8009119aa80f0011aa804800999aa980209000911a80111299a999aa9808090009919a80991199a801910010010009a80091000891980091299a8010816080081491a80091198050010028030801899a80e802001a80d00099aa98038900091a800911919aa80f8019800802990009aa81691299a80089aa8050019109a80111299a99806001004089111980100500209803001801190009aa8131108911299a800880111099802801199aa9803890008028020008890911180180208909111800802190009aa811910891299a8008a80b91099a80c180200119aa98030900080200091199ab9a3371e00400203e03c4446464600200a640026aa04a4466a0029000111a80111299a999ab9a3371e00401204c04a2600e0022600c006640026aa0484466a0029000111a80111299a999ab9a3371e00400e04a04820022600c006446a004444444444444a66a666aa602024002a0224a66a666ae68cdc780700081501489a80d8008a80d00210815081411a800911a8011111111111111999a8069280d1280d1280d1199aa980889000a80911a80091299aa99a999ab9a3371e6a004440046a0084400405a0582666ae68cdc39a801110009a80211000816816081609a80f0018a80e806990009aa80f1108911299a80089a80191000910999a802910011802001199aa980389000802802000899a80091299a801108018800a8040910919800801801244100232323232323333573466e1cd55cea802a400046666644444246666600200c00a0080060046eb8d5d0a80299a805bae35742a0086eb4d5d0a8019bad35742a0046eb4d5d09aba2500223263201e33573803c03e03826ae8940044d5d1280089aba25001135573ca00226ea800448c88c008dd6000990009aa80d111999aab9f0012500d233500c30043574200460066ae880080688c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8064cd5ce00c80d00b89aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba1500233500b017357426ae8940088c98c8078cd5ce00f00f80e09aab9e5001137540026ae854010ccd5402dd728051aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404066ae700800840780740704d55cea80089baa00135742a00466a00eeb8d5d09aba2500223263201a33573803403603026ae8940044d5d1280089aab9e50011375400224464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900c99ab9c01901a017016135573aa00226ea800448488c00800c44880044cd54005d73ad112232230023756002640026aa02844646666aae7c008940208cd401ccd54024c018d55cea80118029aab9e500230043574400602a26ae840044488008488488cc00401000c448848cc00400c0088c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900919ab9c01201301000f00e00d135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900719ab9c00e00f00c135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8030cd5ce00600680509baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8054cd5ce00a80b00980900880800780700689aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401c66ae7003803c03002c4d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200b33573801601801201026aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401866ae700300340280240204d55cea80089baa0012323333573466e1d40052002200523333573466e1d40092000200523263200833573801001200c00a26aae74dd5000891001091000a4c9210350543100120012233700004002224646002002446600660040040021"
};

/* =====================================================
   DATUM SCHEMA
===================================================== */

const OfferDatum = Data.Object({
  borrower: Data.Bytes(),
  lender: Data.Nullable(Data.Bytes()),
  principal: Data.Integer(),
  interest: Data.Integer(),
  collateral: Data.Integer()
});

/* Redeemers */
const postOffer = Data.to(new Constr(0, []));
const acceptOffer = Data.to(new Constr(1, []));
const repayLoan = Data.to(new Constr(2, []));

/* =====================================================
   GLOBAL
===================================================== */

let lucid;
let walletAddress;
let scriptAddress;

/* =====================================================
   INIT
===================================================== */

async function init() {
  lucid = await Lucid.new(
    new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY),
    NETWORK
  );

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  scriptAddress = lucid.utils.validatorToAddress(SCRIPT);
  console.log("walletAddress", walletAddress);
  console.log("scriptAddress", scriptAddress);

  log("Connected");
  log("Script: " + scriptAddress);
}

/* =====================================================
   BORROWER: POST OFFER
===================================================== */

async function postLoanOffer() {
  const collateral = BigInt(document.getElementById("collateral").value) * 1_000_000n;
  const principal  = BigInt(document.getElementById("principal").value)  * 1_000_000n;
  const interest   = BigInt(document.getElementById("interest").value)   * 1_000_000n;
  
  console.log("collateral", collateral);
  console.log("principal", principal);
  console.log("interest", interest);

  const borrowerPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
  console.log("borrowerPkh", borrowerPkh);

  const datum = Data.to({
    borrower: borrowerPkh,
    lender: null,
    principal,
    interest,
    collateral
  }, OfferDatum);
  console.log("datum", datum);

  const tx = await lucid.newTx()
    .payToContract(scriptAddress, { inline: datum }, { lovelace: collateral })
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Offer posted: " + txHash);
}

/* =====================================================
   LENDER: VIEW & ACCEPT OFFERS
===================================================== */

async function loadOffers() {
  const offersDiv = document.getElementById("offers");
  offersDiv.innerHTML = "";

  const utxos = await lucid.utxosAt(scriptAddress);
  console.log("utxos", utxos);
  
  utxos.forEach((u) => {
    if (!u.datum) return;

    const d = Data.from(u.datum, OfferDatum);
    if (d.lender !== null) return;
    console.log("d", d);

    const div = document.createElement("div");
    div.className = "offer";
    div.innerHTML = `
      <p>Principal: ${Number(d.principal) / 1e6} ADA</p>
      <p>Interest: ${Number(d.interest) / 1e6} ADA</p>
      <p>Collateral: ${Number(d.collateral) / 1e6} ADA</p>
      <button>Accept Offer</button>
    `;

    div.querySelector("button").onclick = async () => {
      const lenderPkh =
        lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
      console.log("lenderPkh", lenderPkh);

      const newDatum = Data.to({
        borrower: d.borrower,
        lender: lenderPkh,
        principal: d.principal,
        interest: d.interest,
        collateral: d.collateral
      }, OfferDatum);
      console.log("newDatum", newDatum);

      const borrowerAddr = lucid.utils.credentialToAddress({
        type: "Key",
        hash: d.borrower
      });
      console.log("borrowerAddr", borrowerAddr);

      const tx = await lucid.newTx()
        .collectFrom([u], acceptOffer)
        .attachSpendingValidator(SCRIPT)
        .payToAddress(borrowerAddr, { lovelace: d.principal })
        .payToContract(scriptAddress, { inline: newDatum }, { lovelace: d.collateral })
        .complete();

      const signed = await tx.sign().complete();
      const txHash = await signed.submit();

      log("Offer accepted: " + txHash);
    };

    offersDiv.appendChild(div);
  });
}

/* =====================================================
   BORROWER: REPAY
===================================================== */

async function repay() {
  const borrowerPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
  console.log("borrowerPkh", borrowerPkh);

  const utxos = await lucid.utxosAt(scriptAddress);
  console.log("utxos", utxos);

  const loan = utxos.find((u) => {
    if (!u.datum) return false;
    const d = Data.from(u.datum, OfferDatum);
    return d.borrower === borrowerPkh && d.lender !== null;
  });
  console.log("loan", loan);

  if (!loan) return log("No active loan");

  const d = Data.from(loan.datum, OfferDatum);
  console.log("d", d);

  const lenderAddr = lucid.utils.credentialToAddress({
    type: "Key",
    hash: d.lender
  });
  console.log("lenderAddr", lenderAddr);

  const repayAmount = d.principal + d.interest;
  console.log("repayAmount", repayAmount);

  const tx = await lucid.newTx()
    .collectFrom([loan], repayLoan)
    .attachSpendingValidator(SCRIPT)
    .payToAddress(lenderAddr, { lovelace: repayAmount })
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Loan repaid: " + txHash);
}

/* =====================================================
   UI
===================================================== */

function log(msg) {
  document.getElementById("log").innerText = msg;
}

document.getElementById("connect").onclick = init;
document.getElementById("postOffer").onclick = postLoanOffer;
document.getElementById("refresh").onclick = loadOffers;
document.getElementById("repay").onclick = repay;
