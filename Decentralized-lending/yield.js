import {
  Lucid,
  Blockfrost,
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

/* ===============================
   GLOBALS
   =============================== */

let lucid;
let walletAddress;
let scriptAddress;

/* ===============================
   PLUTUS V2 VALIDATOR
   =============================== */

const YIELD_VALIDATOR_CBOR = "590dfc0100003232323232332232323232323232323322323233223232323232323232323232323232323233223232323223232323232232322323253353232323253333500321533535005222220042153353301c0010041038133573892113626f72726f776572206d757374207369676e210003715335333573466e24c8cccd54c07848004c8cd408c88ccd408c00c004008d4080004cd4088888c00cc008004800488cdc0000a400400290001a9a801910011111111111110022400006c06e206e266ae7124113626f72726f776572206d757374207369676e2100036153353301b3500222002350042222200510361335738921116c656e646572206d757374207369676e21000352321533553353301d35004220023500622222005103813357389201106c656e646572206d757374207369676e000371533535006222220042153355335333573466e214cd4d401488d4008888888888888cccd4034940f4940f4940f48ccd54c0b84800540c48d4004894cd54cd4ccd5cd19b8f3500222002350042200204b04a1333573466e1cd400888004d40108800412c12841284d410400c5410003484ccc074d4d400488004888800c0940944c98c80eccd5ce2491473637269707420696e707574206d697373696e670003c337006a00e444440066a00e444440040700722072266ae712410f6c6f616e206e6f742072657061696400038153355335333573466e20ccc070ccd54c05c48005405540accc050d401c888880154010090090d54008880080e00e440e44cd5ce249196c656e646572206e6f74207061696420636f72726563746c790003815335333573466e20c8ccc074ccd54c06048005405940b0cc0540080040940954010d54008880040e00e440e44cd5ce24811b626f72726f776572206e6f74207061696420636f72726563746c79000381038103813263203a33573892010b6e6f20626f72726f7765720003b103713232335502c500133702006a002266e0ccdc1001000a4190026a00a4444400242a66a6a00a4444400842a66a660380020082070266ae71240112626f72726f776572206d757374207369676e000371326320393357389201146e6f20626f72726f77657220746f2072657061790003a135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40bc0c0d5d0a80619a8178181aba1500b33502f03135742a014666aa066eb940c8d5d0a804999aa819bae503235742a01066a05e07a6ae85401cccd540cc0f9d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4121d69aba150023049357426ae8940088c98c8134cd5ce02682702589aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8243ad35742a00460926ae84d5d1280111931902699ab9c04d04e04b135573ca00226ea8004d5d09aba2500223263204933573809209408e26aae7940044dd50009aba1500533502f75c6ae854010ccd540cc0e88004d5d0a801999aa819bae200135742a00460786ae84d5d1280111931902299ab9c045046043135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860586ae84d5d1280211931901b99ab9c0370380353333573466e1d40152006232122223002005375a6ae84d55cf280391999ab9a3370ea00c90021190911118008029bad357426aae7940208cccd5cd19b875007480088c848888c010014dd69aba135573ca01246666ae68cdc3a80424000424444006464c6407266ae700e40e80dc0d80d40d0cccd5cd19b8735573aa01690001199999111109199998008030028020018011bae35742a01666a04eeb8d5d0a8051bad35742a0126eb4d5d0a8041bad357426ae8940208c98c80d4cd5ce01a81b019881a8b09aab9e50011375400226aae7540044dd500089aba25001135744a00226ae8940044d55cf280089baa00122350012222222222223335530111200122350022222350042233500225335333573466e3c05c0040f00ec4cd40b4018020402080214094028488cd54c01c480048d400488cd54070008cd54c028480048d400488cd5407c008ccd40048cc0c52000001223303200200123303100148000004cd54c01c480048d400488cd54070008ccd40048cd54c02c480048d400488cd54080008d5403400400488ccd5540200340080048cd54c02c480048d400488cd54080008d54030004004ccd55400c020008004444888ccd54c01048005405ccd54c01c480048d400488cd54070008d54024004ccd54c0104800488d4008894cd4ccd54c04048004c8cd405488ccd400c88008008004d40048800448cc004894cd400840b440040a88d400488cc028008014018400c4cd406c01000d4060004cd54c01c480048d400488c8cd5407400cc004014c8004d540b8894cd40044d5402800c884d4008894cd4cc03000802044888cc0080280104c01800c008c8004d5409c88448894cd40044008884cc014008ccd54c01c480040140100044484888c00c0104484888c004010c8004d540908844894cd400454054884cd4058c010008cd54c0184800401000488ccd5cd19b8f00200102001f2223232300100532001355026223350014800088d4008894cd4ccd5cd19b8f002009027026130070011300600332001355025223350014800088d4008894cd4ccd5cd19b8f002007026025100113006003223300335001220020022235002222222222222533533355300f12001501225335333573466e3c0380040a80a44d40800045407c010840a840a0c8004d5407c88448894cd40044d401800c884ccd4024014c010008ccd54c01c4800401401000448d40048800448d4004880084cd4004894cd40088400c4005403048848cc00400c009221001232230023758002640026aa034446666aae7c004940288cd4024c010d5d080118019aba200201a232323333573466e1cd55cea80124000466442466002006004601e6ae854008c014d5d09aba2500223263201933573803203402e26aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460306ae854008cd404005cd5d09aba2500223263201e33573803c03e03826aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931901019ab9c02002101e01d01c135573aa00226ea8004d5d0a80119a8063ae357426ae8940088c98c8068cd5ce00d00d80c09aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5405c88c8cccd55cf80112804119a80399aa80498031aab9d5002300535573ca00460086ae8800c0604d5d08008891001091091198008020018891091980080180109119191999ab9a3370ea002900011a80398029aba135573ca00646666ae68cdc3a801240044a00e464c6402866ae700500540480444d55cea80089baa0011212230020031122001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402466ae7004804c04003c0380344d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6401c66ae7003803c0304d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200c33573801801a01426ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201533573802a02c02602402202001e01c01a26aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900719ab9c00e00f00c00b135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c802ccd5ce00580600480409aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900619ab9c00c00d00a009008135573aa00226ea80048c8cccd5cd19b8750014800880148cccd5cd19b8750024800080148c98c8020cd5ce00400480300289aab9d3754002244004244002932490350543100120012233700004002224646002002446600660040040021";

const script = {
  type: "PlutusV2",
  script: YIELD_VALIDATOR_CBOR,
};

/* ===============================
   INIT LUCID
   =============================== */

async function initLucid() {
  lucid = await Lucid.new(
    new Blockfrost(
      "https://cardano-preprod.blockfrost.io/api/v0",
      "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip"
    ),
    "Preprod"
  );

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  scriptAddress = lucid.utils.validatorToAddress(script);

  log("Wallet connected");
  log("Script address: " + scriptAddress);

  document.getElementById("app").classList.remove("hidden");

  await loadAvailableLoans();
}

/* ===============================
   DATUM
   YieldDatum
   =============================== */

const Nothing = new Constr(1, []);
const Just = (v) => new Constr(0, [v]);

function mkYieldDatum(lender, borrowerMaybe, principal, interest, yieldShare) {
  return Data.to(
    new Constr(0, [
      lender,
      borrowerMaybe,
      BigInt(principal),
      BigInt(interest),
      BigInt(yieldShare),
    ])
  );
}

/* ===============================
   REDEEMERS
   =============================== */

const redeemerDeposit = () => Data.to(new Constr(0, []));
const redeemerBorrow = (amt) => Data.to(new Constr(1, [BigInt(amt)]));
const redeemerRepay = (amt) => Data.to(new Constr(2, [BigInt(amt)]));

/* ===============================
   DEPOSIT (LENDER)
   =============================== */

async function deposit() {
  const depositAmount =
    BigInt(document.getElementById("depositAmt").value) * 1_000_000n;

  const lenderPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  const datum = mkYieldDatum(
    lenderPkh,
    Nothing,
    depositAmount,
    500_000n,
    70n
  );

  const tx = await lucid
    .newTx()
    .payToContract(
      scriptAddress,
      { inline: datum },
      { lovelace: depositAmount }
    )
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Deposit successful: " + txHash);
  await loadAvailableLoans();
}

/* ===============================
   LOAD AVAILABLE LOANS
   =============================== */

async function loadAvailableLoans() {
  const borrowerPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  const utxos = await lucid.utxosAt(scriptAddress);
  const list = document.getElementById("loanList");
  list.innerHTML = "";

  const loans = utxos.filter((u) => {
    if (!u.datum) return false;
    const d = Data.from(u.datum);
    return d.fields[1].fields.length === 0 && d.fields[0] !== borrowerPkh;
  });

  if (loans.length === 0) {
    list.innerHTML = "<p>No available loans</p>";
    return;
  }

  for (const loan of loans) {
    const d = Data.from(loan.datum);
    const [lender, , principal, interest, yieldShare] = d.fields;

    const card = document.createElement("div");
    card.className = "loan-card";

    card.innerHTML = `
      <p><strong>Principal:</strong> ${Number(principal) / 1_000_000} ADA</p>
      <p><strong>Interest:</strong> ${Number(interest) / 1_000_000} ADA</p>
      <p><strong>Yield Share:</strong> ${yieldShare}%</p>
      <button class="secondary">Borrow</button>
    `;

    card.querySelector("button").onclick = () =>
      borrowFromLoan(loan);

    list.appendChild(card);
  }
}

/* ===============================
   BORROW FROM SELECTED LOAN
   =============================== */

async function borrowFromLoan(loanUtxo) {
  const borrowerPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  const borrowerAddr = await lucid.wallet.address();
  const userUtxos = await lucid.wallet.getUtxos();

  const d = Data.from(loanUtxo.datum);
  const [lender, , principal, interest, yieldShare] = d.fields;

  if (lender === borrowerPkh) {
    return log("Cannot borrow your own loan");
  }

  const newDatum = mkYieldDatum(
    lender,
    Just(borrowerPkh),
    principal,
    interest,
    yieldShare
  );

  const tx = await lucid
    .newTx()
    .collectFrom([loanUtxo], redeemerBorrow(principal))
    .collectFrom(userUtxos)
    .attachSpendingValidator(script)
    .payToAddress(borrowerAddr, { lovelace: principal })
    .payToContract(
      scriptAddress,
      { inline: newDatum },
      { lovelace: loanUtxo.assets.lovelace - principal }
    )
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Borrow successful: " + txHash);
  await loadAvailableLoans();
}

/* ===============================
   REPAY
   =============================== */

async function repay() {
  //modify
  // let repayAmt = BigInt(document.getElementById("repayAmt").value);
  // repayAmt = repayAmt * 1_000_000n

  const borrowerPkh =
    lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  const utxos = await lucid.utxosAt(scriptAddress);
  const userUtxos = await lucid.wallet.getUtxos()

  console.log("utxo", utxos);

  // âœ… Find ONLY the loan owned by this borrower
  const loanUtxo = utxos.find((u) => {
    if (!u.datum) return false;

    const d = Data.from(u.datum);
    console.log("datum", d);
    const borrower = d.fields[1];
    console.log("borrower", borrower);
    // Must have a borrower AND match wallet
    if (borrower.fields == undefined) {
      console.log(false);

      return false
    }
    if (!borrower || borrower.fields[0] !== borrowerPkh) return false;
    //  if (!borrower || borrower !== borrowerPkh) return false;
    console.log(u.assets.lovelace);
    // if (u.assets.lovelace >= totalRepayment)
    // Must be a full loan UTxO (5 ADA principal)
    return u.datum;
  });
  console.log("load Utxo", loanUtxo);
  if (!loanUtxo) {
    return log("No repayable loan found for this wallet");
  }
  const userGoodUTxo = userUtxos.find((u) => {
    const d = Data.from(loanUtxo.datum)
    const totalRepayment = BigInt(d.fields[2]) + BigInt(d.fields[3]);


    // if (u.assets.lovelace >= totalRepayment)
    // Must be a full loan UTxO (5 ADA principal)
    return u.assets.lovelace >= totalRepayment;
  });




  const datum = Data.from(loanUtxo.datum);
  const [lender, borrower, principal, interest, yieldShare] = datum.fields;

  const totalRepayment = BigInt(principal) + BigInt(interest);
  console.log({ totalRepayment })
  console.log({ principal })
  console.log({ interest })
  // console.log({ repayAmt });

  if (userGoodUTxo.assets.lovelace < totalRepayment) {
    return log("Repayment must cover principal + interest");
  }

  // âœ… RESET loan after repayment
  // const resetDatum = mkYieldDatum(
  //   lender,
  //   Nothing, // ðŸ”„ borrower reset
  //   principal,
  //   interest,
  //   yieldShare
  // );
  //Dont reset borrower
  const resetDatum = mkYieldDatum(
    lender,
    borrower, // ðŸ”„ borrower reset
    principal,
    interest,
    yieldShare
  );
  const amount = loanUtxo.assets.lovelace + totalRepayment
  const tx = await lucid
    .newTx()
    .collectFrom([userGoodUTxo])
    .collectFrom([loanUtxo], redeemerRepay(totalRepayment))
    .attachSpendingValidator(script)

    // borrower pays into script
    .payToContract(
      scriptAddress,
      { inline: resetDatum },
      // { lovelace: 5_000_000n + repayAmt }
      // { lovelace: totalRepayment }
      { lovelace: totalRepayment }
    )
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Repayment successful & loan reset: " + txHash);
}

/* ===============================
   UI
   =============================== */

function log(msg) {
  document.getElementById("yieldLog").innerText = msg;
}

document.getElementById("connectWallet").onclick = initLucid;
document.getElementById("depositBtn").onclick = deposit;
document.getElementById("repayBtn").onclick = repay;
