import { Lucid, Blockfrost, Constr, Data, toHex, fromHex } from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";
import { NFTStorage } from "https://cdn.jsdelivr.net/npm/nft.storage/dist/bundle.esm.min.js";
/* =====================================================
   CONFIG
===================================================== */
const BLOCKFROST_URL = "https://cardano-preprod.blockfrost.io/api/v0";
const BLOCKFROST_KEY = "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
const NETWORK = "Preprod";
const LTV = 60;

let lucid;
let walletAddress;
let scriptAddress; // Loan script address
let nftPolicy;     // Document NFT policy
let nftPolicyId;   // NFT policy ID

const SCRIPT_CBOR = "590c2401000032323232323322323232323232323233223232332232323232323232323232323233223232322323232323232232232325335323232533500215335330173500122002350032222220061030133573892113626f72726f776572206e6f74207369676e65640002f1533553353301735001220023500322222200610301335738920113626f72726f776572206e6f74207369676e65640002f153355335333573466e20ccc040ccd54c0484800488cd54c05c480048d400488cd540a0008cd54c068480048d400488cd540ac008ccd40048cc0f52000001223303e00200123303d00148000004cd54c05c480048d400488cd540a0008ccd40048cd54c06c480048d400488cd540b0008d5407400400488ccd5540600740080048cd54c06c480048d400488cd540b0008d54070004004ccd55404c0600080054088c8c8d4004888888888888ccd54c0804800488d40088888d401088cd400894cd4ccd5cd19b8f017001047046133503800600810082008503000a35002220023500322222200501b01b337006a0064444440066a00644444400405e0602060266ae712410f6c656e646572206e6f7420706169640002f1533553353500122350022222222222223333500d25034250342503423335530271200150282350012253355335333573466e3cd400888008d4010880081081044ccd5cd19b873500222001350042200104204110411350380031503700d21333573466e1cccc044d4d400488004888800c070070d40108888880100c40c04c98c80c8cd5ce2481146d697373696e672073637269707420696e7075740003310301335738920117636f6c6c61746572616c206e6f742072657475726e65640002f102f102f3333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40a80acd5d0a80619a8150159aba1500b33502a02c35742a014666aa05ceb940b4d5d0a804999aa8173ae502d35742a01066a0540706ae85401cccd540b80e5d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd410dd69aba150023044357426ae8940088c98c8120cd5ce02402482309aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a821bad35742a00460886ae84d5d1280111931902419ab9c048049046135573ca00226ea8004d5d09aba2500223263204433573808808a08426aae7940044dd50009aba1500533502a75c6ae854010ccd540b80d48004d5d0a801999aa8173ae200135742a004606e6ae84d5d1280111931902019ab9c04004103e135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008604e6ae84d5d1280211931901919ab9c0320330303333573466e1d40152002212200123333573466e1d40192000212200223263203233573806406606005e6666ae68cdc39aab9d500b480008cccccc88888848cccccc00401c01801401000c008dd71aba1500b375c6ae854028dd69aba15009375a6ae854020dd69aba15007375a6ae84d5d1280391931901819ab9c03003102e103016135573ca00226ea80044d55ce9baa001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004888c8c8c004014c8004d540a488cd400520002235002225335333573466e3c0080240a80a44c01c0044c01800cc8004d540a088cd400520002235002225335333573466e3c00801c0a40a040044c01800c444888ccd54c01048005404ccd54c01c480048d400488cd54060008d54024004ccd54c0104800488d4008894cd4ccd54c03848004c8cd404488ccd400c88008008004d40048800448cc004894cd400840a440040988d400488cc028008014018400c4cd405c01000d4050004cd54c01c480048d400488c8cd5406400cc004014c8004d540a8894cd40044d5402800c884d4008894cd4cc03000802044888cc0080280104c01800c008c8004d5408c88448894cd40044008884cc014008ccd54c01c480040140100044484888c00c0104484888c004010c8004d540808844894cd400454044884cd4048c010008cd54c0184800401000488ccd5cd19b8f00200101c01b2235002222222222222533533355300f12001501025335333573466e3c0380040a009c4d407800454074010840a04098c8004d5407488448894cd40044d400c88004884ccd401488008c010008ccd54c01c480040140100044cd4004894cd40088400c4005403048848cc00400c009221001232230023758002640026aa034446666aae7c004940288cd4024c010d5d080118019aba200201a232323333573466e1cd55cea80124000466442466002006004601e6ae854008c014d5d09aba2500223263201933573803203402e26aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea8012400046644246600200600460306ae854008cd404005cd5d09aba2500223263201e33573803c03e03826aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931901019ab9c02002101e01d01c135573aa00226ea8004d5d0a80119a8063ae357426ae8940088c98c8068cd5ce00d00d80c09aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5405c88c8cccd55cf80112804119a80399aa80498031aab9d5002300535573ca00460086ae8800c0604d5d08008891001091091198008020018891091980080180109119191999ab9a3370ea002900011a80398029aba135573ca00646666ae68cdc3a801240044a00e464c6402866ae700500540480444d55cea80089baa0011212230020031122001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402466ae7004804c04003c0380344d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6401c66ae7003803c0304d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200c33573801801a01426ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201533573802a02c02602402202001e01c01a26aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900719ab9c00e00f00c00b135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c802ccd5ce00580600480409aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900619ab9c00c00d00a009008135573aa00226ea80048c8cccd5cd19b8750014800880148cccd5cd19b8750024800080148c98c8020cd5ce00400480300289aab9d3754002244004244002932490350543100120012233700004002224646002002446600660040040021";
const script = { type: "PlutusV2", script: SCRIPT_CBOR };

const NFT_POLICY_CBOR = "5908a0010000323322332232323232323232323232323232323232323232223232533532325335533553353233019501c001355001222222222222008101c22135002222533500415335333573466e3c00cd401c88cccd40048c98c8078cd5ce2481024c680001f200123263201e3357389201024c680001f23263201e3357389201024c680001f0220211333573466e1c00520020220211021221023101d13357389201226d757374206d696e742065786163746c79206f6e6520646f63756d656e74204e46540001c153355335355001222222222222004101c2215335001101f221020101d133573892011e626f72726f776572206d757374207369676e207472616e73616374696f6e0001c101c135001220023333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd4050054d5d0a80619a80a00a9aba1500b33501401635742a014666aa030eb9405cd5d0a804999aa80c3ae501735742a01066a02803a6ae85401cccd54060079d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40a1d69aba150023029357426ae8940088c98c80accd5ce01581601489aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8143ad35742a00460526ae84d5d1280111931901599ab9c02b02c029135573ca00226ea8004d5d09aba2500223263202733573804e05004a26aae7940044dd50009aba1500533501475c6ae854010ccd540600688004d5d0a801999aa80c3ae200135742a00460386ae84d5d1280111931901199ab9c023024021135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00460186ae84d5d1280111931900a99ab9c015016013101516135573ca00226ea800448c88c008dd6000990009aa80c111999aab9f00125018233501730043574200460066ae8800804c8c8c8cccd5cd19b8735573aa004900011991091980080180118051aba150023005357426ae8940088c98c8048cd5ce00900980809aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa004900011991091980080180118099aba1500233500d012357426ae8940088c98c805ccd5ce00b80c00a89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403266ae7006406805c0580544d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201333573802602802226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355015223233335573e0044a02c466a02a66442466002006004600c6aae754008c014d55cf280118021aba200301113574200224464646666ae68cdc3a800a40004642446004006600a6ae84d55cf280191999ab9a3370ea0049001109100091931900819ab9c01001100e00d135573aa00226ea80048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01001100e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00c00d00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00500580409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00980a00880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700300340280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801201400e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002802c02001c0184d55cea80089baa0012323333573466e1d40052002200c23333573466e1d40092000200c23263200633573800c00e00800626aae74dd5000a4c92103505431001200132001355006222533500110022213500222330073330080020060010033200135500522225335001100222135002225335333573466e1c005200000c00b13330080070060031333008007335009123330010080030020060031122002122122330010040031220021220011123230010012233003300200200101";
nftPolicy = { type: "PlutusV2", script: NFT_POLICY_CBOR };

/* =====================================================
   DATUM SCHEMA (LOAN)
===================================================== */
const LoanDatum = Data.Object({
  borrower: Data.Bytes(),
  lender: Data.Bytes(),
  collateral: Data.Integer(),
  principal: Data.Integer(),
  interest: Data.Integer(),
  ltv: Data.Integer(),
});

/* =====================================================
   DATUM / REDEEMER
===================================================== */
function mkLoanDatum(borrower, lender, collateral, principal, interest) {
  return Data.to(
    { borrower, lender, collateral: BigInt(collateral), principal: BigInt(principal),
      interest: BigInt(interest), ltv: BigInt(LTV) },
    LoanDatum
  );
}
const openLoanRedeemer  = Data.to(new Constr(0, []));
const repayLoanRedeemer = Data.to(new Constr(1, []));

/* =====================================================
   INIT
===================================================== */
async function init() {
  lucid = await Lucid.new(new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY), NETWORK);

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();

  // Loan script CBOR
  
  scriptAddress = lucid.utils.validatorToAddress(script);

  // NFT Minting Policy CBOR
  
  nftPolicyId = lucid.utils.mintingPolicyToId(nftPolicy);

  log("Wallet connected: " + walletAddress);
  log("NFT Policy ID: " + nftPolicyId);
  log("Loan Script Address: " + scriptAddress);
}

/* =====================================================
   DOCUMENT NFT MINTING
===================================================== */
async function mintDocumentNFT() {
  const fileInput = document.getElementById("docUpload");
  //const nftNameInput = document.getElementById("nftName");

  if (!fileInput.files.length) return log("Select a file");
  const file = fileInput.files[0];
  //const name = nftNameInput.value || file.name;

  const arrayBuffer = await file.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", arrayBuffer);
  const hashHex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");

const walletAddress = await lucid.wallet.address();

const ownerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;


const redeemer = Data.to(new Constr(0, []));

const assetNameHex = hashHex; // MUST MATCH docHash on-chain

const assetName = nftPolicyId + assetNameHex;

const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI1ODI1MGRjNi1mNTY2LTQwY2YtYjhhYy1hNzVjY2IyMzBiYWUiLCJlbWFpbCI6InV6b3Vrd3VzYXZpb3VyQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI0ZWQzNDk3NzU1ZGVlNDk5ZTljYSIsInNjb3BlZEtleVNlY3JldCI6IjgzOTE1MTM5NjM1YzAwNzhjZTVmNTMwNTlhOWZhZDBmNWIzOTBkNTg3NDgxMjhlMWM1NTJmMzdjZDcwNWY5YzEiLCJleHAiOjE4MDAxMzM5NzJ9.SkmqU6wEjsTMeTJQXryjABU2_-2wg3PhTOcEAAc5mb4";

async function uploadToIPFS(file) {
  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch(
    "https://api.pinata.cloud/pinning/pinFileToIPFS",
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`,
      },
      body: formData,
    }
  );

  if (!res.ok) {
    throw new Error("Pinata upload failed");
  }

  const data = await res.json();
  return data.IpfsHash;
}

// API Key: 4ed3497755dee499e9ca
// API Secret: 83915139635c0078ce5f53059a9fad0f5b390d58748128e1c552f37cd705f9c1
// JWT: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI1ODI1MGRjNi1mNTY2LTQwY2YtYjhhYy1hNzVjY2IyMzBiYWUiLCJlbWFpbCI6InV6b3Vrd3VzYXZpb3VyQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI0ZWQzNDk3NzU1ZGVlNDk5ZTljYSIsInNjb3BlZEtleVNlY3JldCI6IjgzOTE1MTM5NjM1YzAwNzhjZTVmNTMwNTlhOWZhZDBmNWIzOTBkNTg3NDgxMjhlMWM1NTJmMzdjZDcwNWY5YzEiLCJleHAiOjE4MDAxMzM5NzJ9.SkmqU6wEjsTMeTJQXryjABU2_-2wg3PhTOcEAAc5mb4

const cid = await uploadToIPFS(file);

const ipfsUrl = `ipfs://${cid}`;

const httpUrl = `https://ipfs.io/ipfs/${cid}`;

const metadata = {
  721: {
    [nftPolicyId]: {
      [assetNameHex]: {
        name: "Collateral Document",
        image: ipfsUrl,
        mediaType: file.type,
        files: [
          {
            name: "Collateral Document",
            mediaType: file.type,
          }
        ]
      }
    }
  }
};


const addr = document.getElementById("reciepient").value;

  const num = BigInt(1n);

  const tx = await lucid.newTx()
    .mintAssets({ [assetName]: num },
        redeemer
    )
    .attachMintingPolicy(nftPolicy)
    .attachMetadata(721, metadata[721])
    .payToAddress(addr, { [assetName]: num, lovelace: 2_000_000n, })
    .addSignerKey(ownerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();
  log("Document Minted And Transfered: " + txHash);
  log("Verify Document Here: " + httpUrl);
}

/* =====================================================
   OPEN LOAN
===================================================== */
async function openLoan() {
  const collateralAda = BigInt(document.getElementById("collateral").value) * 1_000_000n;
  const principalAda  = BigInt(document.getElementById("principal").value) * 1_000_000n;
  const lenderAddr    = document.getElementById("lender").value;
  const interest      = BigInt(document.getElementById("interest").value) * 1_000_000n;

  //if (principalAda * 100n > collateralAda * BigInt(LTV)) return log("LTV exceeded");

  const borrowerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
  const lenderPkh   = lucid.utils.getAddressDetails(lenderAddr).paymentCredential.hash;

  const datum = mkLoanDatum(borrowerPkh, lenderPkh, collateralAda, principalAda, interest);

  const tx = await lucid.newTx()
    .payToContract(scriptAddress, { inline: datum }, { lovelace: collateralAda })
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();
  log("Loan opened: " + txHash);
}

/* =====================================================
   REPAY LOAN
===================================================== */
async function repayLoan() {
  const borrowerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
  const utxos = await lucid.utxosAt(scriptAddress);
  const loanUtxo = utxos.find(u => u.datum && Data.from(u.datum, LoanDatum).borrower === borrowerPkh);

  if (!loanUtxo) return log("No active loan found");

  const d = Data.from(loanUtxo.datum, LoanDatum);
  const totalRepay = d.principal + d.interest;
  const lenderAddr = lucid.utils.credentialToAddress({ type: "Key", hash: d.lender });

  const tx = await lucid.newTx()
    .collectFrom([loanUtxo], repayLoanRedeemer)
    .attachSpendingValidator(script)
    .payToAddress(lenderAddr, { lovelace: totalRepay })
    .addSignerKey(borrowerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();
  log("Loan repaid: " + txHash);
}

/* =====================================================
   LOG + EVENT HANDLERS
===================================================== */
function log(msg) { document.getElementById("log").innerText = msg; }

document.getElementById("connect").onclick = init;
document.getElementById("mintNFT").onclick = mintDocumentNFT;
document.getElementById("openLoan").onclick = openLoan;
document.getElementById("repayLoan").onclick = repayLoan;
